# Static Web Site Template

This is a CloudFormation template for deploying cloud infrastructure required to host a static website on [AWS](https://aws.amazon.com).

Suppose you want to host a [TiddlyWiki](https://tiddlywiki.com/) website, a blog generated by [Hugo](https://gohugo.io/) or a picture gallery created with [Mikula](https://github.com/RomanKosobrodov/mikula). If this is something you do every week you'll be done in 5 minutes. This template is for the rest of us and requires minimum of skills to have the site up and running.

If you prefer detailed step-by-step instructions with screenshots check [my post](https://blog.kosobrodov.net) on hosting a TiddlyWiki site. The setup is essentially the same for all static web sites.

## What this template does

The template creates a subdomain on your existing domain, for example `blog.community.org`, obtains an SSL/TLS certificate from AWS to support secure connections on `https://blog.community.org`, creates an S3 bucket to store the content of your site and CloudFront distribution to serve it with minimal delay across the globe.

## How expensive is it?

I have two domains and several static websites. As of July 2022, my total monthly costs for running the whole infrastructure is below $2. If you run a popular resource your costs would be higher since you will be paying for what you use.

## Prerequisites

In order to use this template you need the following:

1. AWS account with sufficient permissions to create Route53 records, request certificates, create S3 buckets and CloudFront distributions, and deploy CloudFormation stacks.
2. A domain hosted with Route53.
3. [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html) tool is optional but strongly recommended at least for testing purposes

## Using the template

You can clone this repository or simply [download the template](/blob/main/template.yaml) and follow this steps:

1. Login to your [AWS Console](https://console.aws.amazon.com). If you only have a root account, log in as root. Otherwise, use an account with administrative permissions.
2. Navigate to CloudFormation console.
3. **Important**: Change the region to **"US East (N. Virginia)"**. CloudFront will only accept certificates issued in that region.
4. Click the orange "Create Stack" or choose "With new resources (standard)" from the "Create Stack" dropdown list.
5. In the "Specify Template" section select "Upload a template file", click "Upload file" and select the template you downloaded.
6. In the "Specify stack details" form you need to provide:
   - a name for the stack we are creating, for example "aws-static-site"
   - domain ID from the dropdown list. If this list is empty you need to create a hosted zone for your domain before you can proceed.
   - full domain name for your website including the subdomain, for example "blog.community.org"
   - enable the "Append index.html" feature if you are going to host a blog or other site with "pretty" links, and finally
   - choose a name for the IAM user. This user will have full access to the S3 bucket storing your website content.
7. Click "Next". You don't need to make any changes in the "Configure stack options" so click "Next" again.
8. In the "Review" form check "I acknowledge that AWS CloudFormation might create IAM resources with custom names." We are creating a new user and need specifically approve this action.

You can monitor the stack creation progress on the "Events" tab. It usually takes several minutes. When the creation is complete open the Outputs tabs, we are going to use it next.

## Configuring AWS CLI

We now need to configure AWS CLI to be able to upload content to our website. Run the following command from your terminal (or Command Prompt if you are using Windows):

```bash
aws configure --profile blog-writer
```

This will create AWS credentials for a user called `blog-writer`. You can choose a better name of course. The command will prompt for `AWS Access Key ID` and `AWS Secret Access Key`. Copy these parameters from the Outputs of the stack. The names are confusing, and the values are meaningless so be careful and use the right one. The "secret" is almost twice as long as the "key". The region and the output format are not important, use "us-east-1" and "json", respectively. Keep the terminal (Command Prompt) open, we are not done with it yet.

## Testing the Build

Everything is ready now to test our site! [Download](/blob/main/index.html) a placeholder HTML document or create your own `index.html` file and then type:

```bash
aws s3 cp index.html s3://<site-bucket-name> --profile <name>
```

where <site-bucket-name> is the name of the bucket that can be found in the stack outputs. It is your full subdomain name with the dots replaced by hyphens. The <name> is the name of the AWS CLI profile we have just created. In my case the command looks like:

```bash
aws s3 cp index.html s3://blog-kosobrodov-net --profile roman
```

Make sure your `index.html` is in the current directory, if not provide a full path. Hit Enter and you should see the message:

```bash
upload: .\index.html to s3://<site-bucket-name>/index.html
```

Now open the browser and navigate to your site. You should see the content of index.html informing you that your next great website has been successfully deployed. OK, it's "coming soon" but still ...

Congratulations! We've done a great job.

## Uploading Content

Your AWS CLI profile has been saved and will now persist in the system. Once you've tested your website locally, navigate to the directory containing the site and run the following command:

```bash
aws sync . s3://<site-bucket-name> --profile <name>
```

This will synchronise your local directory and the bucket. If you deleted some files locally and want them to be removed from the bucket include the `--delete` flag:

```bash
aws sync . s3://<site-bucket-name> --profile <name> --delete
```

You can swap source and destination in the command and the content of the bucket will be put in your local directory:

```bash
aws sync s3://<site-bucket-name> . --profile <name> --delete
```

## Deleting the Infrastructure

If for some reason you decide to delete the website with all the infrastructure you can open AWS CloudFormation console, highlight your stack and click "Delete". If your website bucket is not empty the deletion will fail. By running it the second time you can choose to retain the bucket if you decide to keep its content. After removing the rest of the stack the content of the bucket will no longer be publicly available, but you would still have access to it via AWS CLI or the web console.

If you want to completely wipe out the website, bucket and all, empty the bucket first:

```bash
aws s3 rm s3://<site-bucket-name> --profile <name> --recursive
```

and then delete the stack.

## Issues and feedback

If you have a problem with the template please use GitHub to [raise an issue](https://github.com/RomanKosobrodov/aws-static-website-template/issues). If it worked for you please give this repository a star on GitHub.
